# 1. 問題の概要
- 作業ビューで「描画ツール」「キャプチャ」ボタンが押せず、以前は使えていた。
- 発生環境: ローカル
- ブラウザConsole: エラーなし（ユーザー申告）
- 直前の変更/要望: 「動画後ろの背景にも描けるように」する指示以降から発生

# 2. 発生している事象
- 描画ツール（ツールバーの各ボタン）を押しても切り替わらない/反応しない
- キャプチャボタンを押しても反応しない
- Console にエラーは表示されない

再現手順（ユーザー申告ベース）
- ローカル環境で作業ビューを開く
- 描画ツール・キャプチャを操作する
- いずれも反応しない

# 3. 調査内容と観察結果
確認した主なファイル
- `routes/web.php`
- `app/Http/Controllers/ProjectController.php`
- `app/Http/Controllers/ProjectShareController.php`
- `resources/views/projects/show.blade.php`
- `resources/js/video-analysis.js`
- `resources/views/components/layouts/fullscreen.blade.php`

観察結果（事実）
- `routes/web.php` では、編集用のプロジェクト画面は `projects.show`（`/projects/{project}`）で、`auth` ミドルウェア配下にある。
- 一方 `share/{token}`（`projects.share`）は認証なしでアクセスでき、コントローラ `ProjectShareController@show` は `readOnly => true` を常に view に渡す。
- `resources/views/projects/show.blade.php` の作業ビュー表示条件は以下:
  - `$isWorkingView = (! $readOnly && ($workingView ?? false)) || $selectedVideo instanceof \App\Models\Video;`
  - つまり、共有リンク（`readOnly=true`）であっても、動画が存在する場合は作業ビュー（`#video-analysis`）が表示され得る。
- `resources/js/video-analysis.js` は `readOnly` を `root.dataset.readOnly === '1'` で判定している。
- `resources/js/video-analysis.js` のイベントは、多数の箇所で `if (readOnly) return;` により無反応になる（例: ツール選択、キャプチャ、描画操作）。
- UI上の disabled 属性の付与は一部のボタン（例: キャプチャ、保存など）に限定され、ツールボタンは disabled にならないため、見た目は押せそうでも動作は抑止される可能性がある。

期待する挙動とのギャップ
- ユーザーは「作業ビューで編集可能（描画・キャプチャ可能）」を期待している。
- 実際には `readOnly=true` と判定されている場合、UIは表示されてもイベント処理が readOnly ガードで止まり、結果として「押せない」ように見える可能性が高い。

# 4. 原因の仮説
仮説A（有力）: 共有リンク（`/share/{token}`）で開いており `readOnly=true` になっている
- 根拠:
  - 共有ルートは必ず `readOnly=true` で view をレンダリングする。
  - 共有ルートでも動画が存在すると作業ビューが表示され得る。
  - JS側は `readOnly` のとき多くの操作を `return;` で抑止するため、Consoleエラーが無くても「押せない」状態になる。

仮説B: `#video-analysis` 内のDOMが差し替わり、イベントリスナーが意図せず外れている
- 根拠:
  - ページ遷移やDOM更新の仕組み次第で、表示はあるが操作だけ効かないケースがあり得る。
  - ただし現時点では、Consoleエラーなし・特定の挙動ログも無いため確証不足。

# 5. 影響範囲
- 作業ビュー（`#video-analysis`）での編集操作全般:
  - ツール切り替え、描画、キャプチャ、保存等
- 特に `readOnly` 判定が想定より広く適用されている場合:
  - 共有リンクで閲覧しているユーザー（または共有URLを誤って開いた編集者）が操作不能になる

不明点・要確認事項
- 実際に開いているURLが `projects.show`（`/projects/{id}`）なのか、`projects.share`（`/share/{token}`）なのか（ユーザー未提示）
- ボタンに `disabled` 属性が付いているか（DevTools要確認）

# 6. 今後の対応メモ（任意）
追加で行うべき調査（優先順）
- 開いているURLを確認し、`/share/` かどうかを切り分ける。
- DevToolsで `#video-analysis` 要素の `data-read-only` 値を確認する（`0` か `1`）。
- キャプチャボタン（`[data-action="capture"]`）の `disabled` 属性有無を確認する。

実装・修正を行う場合の方針案（方針のみ）
- 共有リンクで開いているだけなら、編集用URL（`/projects/{project}?work=1`）への導線をUI上で明確にする、または共有リンク上のツールボタンを明確に disabled 表示にする。
- 認証済みオーナーが共有リンクを開いた場合は編集可能にしたい、という仕様であれば、共有コントローラ側で「閲覧者がオーナーなら readOnly=false」にする等の要件整理が必要。

