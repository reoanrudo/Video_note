# Requirements（動画解析ツール / Video Note）

参照:
- 既存ドラフト: `.sdd/requirements/requirements.md`
- Steering: `.sdd/steering/product.md`, `.sdd/steering/tech.md`, `.sdd/steering/structure.md`

## 1. ゴール
- 動画アップロード → 注釈保存 → 共有閲覧 の一連を安定提供する。
- **週あたりのプロジェクト作成数**を計測できるよう、**DBにイベントを記録**できる状態にする。
- 将来的な課金/制限解除に備え、ユーザーが**プランを選択できる**（ただし現時点では制限解除は実装しない）。

## 2. スコープ

### In scope（今回）
- プロジェクト作成（無料: 10件上限）
- 動画アップロード（<=500MB、許可MIME）
- 注釈（drawings/snapshots/settings）をJSONとして保存
- スナップショット（png）保存
- 共有リンク（匿名閲覧のみ、編集不可）
- 無料ユーザーの7日保持と、削除前通知（メール・24時間前）＋削除ジョブ
- KPI（プロジェクト作成イベント）をDBに記録
- プラン選択（UI/保存）※制限解除はしない

### Out of scope（今回）
- 有料プランの決済/購入/課金フロー
- プランによる上限緩和・保存期間延長（データ/拡張前提のみ）
- 監査ログの厳密設計、外部分析基盤連携（DB記録以外）
- モバイル最適化

## 3. ユーザーストーリー
1) オーナーはダッシュボードからプロジェクトを作成できる。  
2) オーナーはプロジェクトに動画(<=500MB)をアップロードできる。  
3) オーナーは動画上に描画/テキスト/番号を付け、JSONとして保存できる。  
4) オーナーは任意の時点のスナップショット(png)を保存できる。  
5) オーナーは共有リンクを生成し、ログイン不要の閲覧者が同じ動画と注釈を閲覧できる（編集不可）。  
6) システムは無料ユーザーのデータを7日後に削除し、削除の24時間前にメール通知する。  
7) システムはプロジェクト作成イベントをKPI計測用にDBへ記録できる。  
8) ユーザーは（将来用に）プランを選択できる（選択しても制限は変わらない）。  

## 4. 機能要件

### 4.1 プロジェクト
- 無料ユーザーの作成上限: 10件
  - 上限超過時はエラーメッセージを返す
- 作成時に共有用トークン（`share_token`）を払い出せる

### 4.2 動画アップロード
- 1ファイル上限: 500MB
- 許可 MIME: `video/mp4`, `video/quicktime`, `video/webm`, `video/ogg`
  - 運用上の互換として `application/octet-stream` を許容しても良い
- 保存先: `public` ディスク

### 4.3 注釈/描画
- `videos.annotations` にJSONとして保存する
- フォーマットは原則として以下を持つ:
  - `drawings`: 描画配列（ペン/矢印/テキスト/番号等の要素）
  - `snapshots`: スナップショット配列
  - `settings`: UI設定（色/太さ/連番など）

### 4.4 スナップショット
- png を `public` ディスクへ保存する
- **重要**: スナップショット削除に使うため、スナップショットは `path`（storage上の相対パス）を保持できる

### 4.5 共有（閲覧のみ）
- 共有URLは `share_token` で閲覧対象プロジェクトを特定する
- 共有ページでは動画・注釈の閲覧のみ可能（編集/保存は不可）
- 共有閲覧者（未ログイン）が保存系ルートへアクセスした場合の挙動:
  - **302（ログイン画面へのリダイレクト）を許容**する（必要に応じて将来 401/403/404 へ変更）

### 4.6 自動削除（無料ユーザー）
- 対象: 動画ファイル、スナップショット画像、注釈JSON（DB上の該当レコード）
- 期限: 7日経過後に削除
- 削除前通知: **メール**で期限24時間前に通知（キュー経由）

### 4.7 KPI 計測（DB）
- プロジェクト作成時に、KPI計測用のイベントをDBに記録する
- 最低限必要な情報:
  - `user_id`（作成者）
  - `project_id`
  - `event`（例: `project_created`）
  - `occurred_at`（作成日時）
- 集計は後続でも良いが、週次集計ができる情報は保持する

### 4.8 プラン選択（将来用）
- ユーザーが「プラン」を選択し保存できる
- **選択しても現時点では上限/保持期間は変わらない**
- 目的は将来の課金/制限解除実装に備えること

## 5. 非機能要件
- 認証/認可: Fortify + Policy（編集はオーナーのみ）
- 対応端末: 当面PC優先
- テスト: Pest（Feature中心）

## 6. 受け入れ条件（Acceptance Criteria）
- プロジェクト作成〜共有閲覧のhappy pathがPest Featureテストで通る
- 500MB超の動画アップロードに対し、バリデーションエラーを返す
- 無料ユーザーで10件超の作成リクエストに対し、制限メッセージが返る
- 共有リンクで閲覧できる（匿名OK、readOnly）
- 共有閲覧者が保存系エンドポイントへアクセスすると拒否される（302許容）
- 7日経過データの削除コマンドが存在し、対象レコード/ファイルが消える（テストで確認）
- 削除24時間前の通知コマンドが存在し、メール通知が送信される（テストで確認）
- プロジェクト作成時にKPIイベントがDBへ記録される（テストで確認）
- ユーザーがプランを選択し、選択内容が永続化される（テストで確認）

## 7. 未決・要検討（次の要件確定で詰める）
- プランの選択肢（例: Free/Pro）と表記、変更可否（いつでも変更？）
- KPIイベントのテーブル名/設計詳細（汎用イベントテーブルか、project_events専用か）
- KPIの集計表示（ダッシュボード表示の有無、週の定義、タイムゾーン）

