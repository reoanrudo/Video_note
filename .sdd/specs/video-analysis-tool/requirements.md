# Requirements（動画解析ツール / Video Note）

参照:
- 既存ドラフト: `.sdd/requirements/requirements.md`
- Steering: `.sdd/steering/product.md`, `.sdd/steering/tech.md`, `.sdd/steering/structure.md`

## 1. ゴール
- 動画アップロード → 注釈保存 → 共有閲覧 の一連を安定提供する。
- **週あたりのプロジェクト作成数**を計測できるよう、**DBにイベントを記録**できる状態にする。
- 将来的な課金/制限解除に備え、ユーザーが**プランを選択できる**（ただし現時点では制限解除は実装しない）。

## 2. スコープ

### In scope（今回）
- プロジェクト作成（無料: 10件上限）
- 動画アップロード（<=500MB、許可MIME）
- 注釈（drawings/snapshots/settings）をJSONとして保存
- スナップショット（png）保存
- 共有リンク（匿名閲覧のみ、編集不可）
- 無料ユーザーの7日保持と、削除前通知（メール・24時間前）＋削除ジョブ
- KPI（プロジェクト作成イベント）をDBに記録
- プラン選択（UI/保存）※制限解除はしない

### Out of scope（今回）
- 有料プランの決済/購入/課金フロー
- プランによる上限緩和・保存期間延長（データ/拡張前提のみ）
- 監査ログの厳密設計、外部分析基盤連携（DB記録以外）
- モバイル最適化

## 3. ユーザーストーリー

### 3.1 ストーリーとビジネスゴール

1. **プロジェクト作成**
   - As オーナー
   - I want ダッシュボードからプロジェクトを作成できる
   - So that 動画解析作業を整理・管理できる

2. **動画アップロード**
   - As オーナー
   - I want プロジェクトに動画(<=500MB)をアップロードできる
   - So that 解析対象動画を安全に保管できる

3. **注釈付け**
   - As オーナー
   - I want 動画上に描画/テキスト/番号を付け、JSONとして保存できる
   - So that 動画の重要ポイントを記録・共有できる

4. **スナップショット保存**
   - As オーナー
   - I want 任意の時点のスナップショット(png)を保存できる
   - So that 静止画として証拠資料やレポートに活用できる

5. **共有閲覧**
   - As オーナー
   - I want 共有リンクを生成し、ログイン不要の閲覧者が同じ動画と注釈を閲覧できる（編集不可）
   - So that チームメンバーや顧客に解析結果を簡単に共有できる

6. **自動削除と通知**
   - As システム管理者
   - I want 無料ユーザーのデータを7日後に削除し、削除の24時間前にメール通知する
   - So that ストレージコストを管理しつつユーザー体験を損なわない

7. **KPI計測**
   - As プロダクトマネージャー
   - I want プロジェクト作成イベントをKPI計測用にDBへ記録できる
   - So that 週次成長率を測定し、事業判断に活用できる

8. **プラン選択（将来用）**
   - As ユーザー
   - I want プランを選択できる（選択しても制限は変わらない）
   - So that 将来の有料プランへスムーズに移行できる

### 3.2 具体例（Specification by Example）

**例1: プロジェクト作成と上限チェック**

```gherkin
Given 無料ユーザー（user_id=1）が9件のプロジェクトを作成済み
When ダッシュボードで「新規プロジェクト作成」ボタンをクリック
And プロジェクト名「テニスフォーム分析」を入力して送信
Then プロジェクトが作成され、ID=10が払い出される
And KPIイベント（event='project_created', user_id=1, project_id=10）がDBに記録される
And ダッシュボードに10件のプロジェクトが表示される

Given 無料ユーザー（user_id=1）が10件のプロジェクトを作成済み
When ダッシュボードで「新規プロジェクト作成」ボタンをクリック
And プロジェクト名「サッカー試合分析」を入力して送信
Then バリデーションエラーが表示される
And エラーメッセージ「プロジェクトは10件までです」が表示される
And プロジェクトは作成されない
```

**例2: 動画アップロードとバリデーション**

```gherkin
Given プロジェクト（id=1, owner=user_1）が存在する
When オーナーがプロジェクトページで動画ファイル（450MB, video/mp4）を選択
And アップロードボタンをクリック
Then 動画ファイルが `storage/app/public/videos/{project_id}/{filename}` に保存される
And videosテーブルにレコード（project_id=1, filename, path）が作成される
And プロジェクトページに動画プレイヤーが表示される

Given プロジェクト（id=1, owner=user_1）が存在する
When オーナーがプロジェクトページで動画ファイル（550MB, video/mp4）を選択
And アップロードボタンをクリック
Then バリデーションエラーが表示される
And エラーメッセージ「動画サイズは500MB以下にしてください」が表示される
And 動画はアップロードされない
```

**例3: スナップショット保存と削除契約**

```gherkin
Given プロジェクト（id=1, owner=user_1）に動画（id=10）が存在する
When オーナーが動画再生中（10:30時点）でスナップショットボタンをクリック
And スナップショット名「フォーム1」を入力して保存
Then pngファイルが `storage/app/public/snapshots/{video_id}/{timestamp}.png` に保存される
And annotationsのsnapshotsセクションに以下が追加される:
  - name: "フォーム1"
  - timestamp: 10.5
  - path: "snapshots/{video_id}/{timestamp}.png"  # ★削除時に使用
And プロジェクトページのスナップショット一覧に「フォーム1」が表示される

Given 7日経過した動画（id=10）のスナップショットが3件存在する
When 削除コマンド `php artisan videos:delete-expired` を実行
Then annotationsのsnapshotsから `path` を読み取る
And 各スナップショットファイルが物理削除される
And videoレコードがDB削除される
And スナップショットのpath情報も同時に削除される
```

**例4: 削除前通知**

```gherkin
Given 6日前に作成された動画（id=20, user=user_1）が存在する
And user_1のメールアドレスは "user@example.com"
When 通知コマンド `php artisan videos:notify-expiring` を実行（6日23時間後）
Then ExpiringVideoNotification がキューに追加される
And キューワーカーがメールを送信する
And メール件名は「動画が24時間後に削除されます」
And メール本文にプロジェクト名と動画名が含まれる
And user@example.com に配信される

Given user_1が3件の削除対象動画を持つ
When 通知コマンドを実行
Then 1通のメールに3件の動画情報がまとめられる
And メールは1通のみ送信される（グルーピング）
```

**例5: 共有リンク閲覧**

```gherkin
Given プロジェクト（id=1, share_token="abc123..."）が存在する
And 注釈（drawings=[{type:"arrow",...}], snapshots=[...]）が保存済み
When 未ログインユーザーが `https://example.com/share/abc123...` にアクセス
Then プロジェクトページが表示される
And 動画プレイヤーが再生可能
And 注釈（矢印・テキスト等）が動画上に表示される
And 編集ボタン（保存・削除等）は非表示
And 閲覧者は注釈を変更できない

Given プロジェクト（id=1, share_token="abc123..."）が存在する
When 未ログインユーザーが注釈保存API `POST /projects/1/videos/10/annotations` にアクセス
Then 302リダイレクト（ログインページ）が返される  # ★現時点では許容
```


## 4. 機能要件

### 4.1 プロジェクト
- 無料ユーザーの作成上限: 10件
  - 上限超過時はエラーメッセージを返す
- 作成時に共有用トークン（`share_token`）を払い出せる

### 4.2 動画アップロード
- 1ファイル上限: 500MB
- 許可 MIME: `video/mp4`, `video/quicktime`, `video/webm`, `video/ogg`
  - 運用上の互換として `application/octet-stream` を許容しても良い
- 保存先: `public` ディスク

### 4.3 注釈/描画
- `videos.annotations` にJSONとして保存する
- フォーマットは原則として以下を持つ:
  - `drawings`: 描画配列（ペン/矢印/テキスト/番号等の要素）
  - `snapshots`: スナップショット配列
  - `settings`: UI設定（色/太さ/連番など）

### 4.4 スナップショット

#### 4.4.1 保存仕様
- 形式: png
- 保存先: `public` ディスク（`storage/app/public/snapshots/{video_id}/{timestamp}.png`）
- メタデータ: `videos.annotations` JSON内の `snapshots` 配列に保存

#### 4.4.2 スナップショット削除契約（Critical Contract）

**契約内容**: スナップショットファイルを物理削除するため、各スナップショットは必ず `path` フィールドを保持しなければならない。

**データ構造**:
```json
{
  "snapshots": [
    {
      "name": "フォーム1",
      "timestamp": 10.5,
      "path": "snapshots/{video_id}/{timestamp}.png"  // ★必須★
    }
  ]
}
```

**契約保証**:
1. **保存時**: `ProjectVideoController::storeSnapshot()` は必ず `path` を含むスナップショットオブジェクトを生成する
2. **削除時**: `DeleteExpiredVideos` コマンドは `path` の存在を前提として動作する
3. **path無しの扱い**: 既存データで `path` が無い場合、警告ログを出力し、そのスナップショットは削除対象外とする（DB削除は実行、ファイル削除はスキップ）

**テスト保証**:
- `SnapshotDeletionContractTest` でライフサイクル全体をE2Eテスト
- 保存→注釈更新→削除の一連の流れで `path` の伝播を検証

**リスク**: この契約が破られると、スナップショットファイルが孤立し、ストレージリークが発生する

### 4.5 共有（閲覧のみ）
- 共有URLは `share_token` で閲覧対象プロジェクトを特定する
- 共有ページでは動画・注釈の閲覧のみ可能（編集/保存は不可）
- 共有閲覧者（未ログイン）が保存系ルートへアクセスした場合の挙動:
  - **302（ログイン画面へのリダイレクト）を許容**する（必要に応じて将来 401/403/404 へ変更）

### 4.6 自動削除（無料ユーザー）
- 対象: 動画ファイル、スナップショット画像、注釈JSON（DB上の該当レコード）
- 期限: 7日経過後に削除
- 削除前通知: **メール**で期限24時間前に通知（キュー経由）

### 4.7 KPI 計測（DB）
- プロジェクト作成時に、KPI計測用のイベントをDBに記録する
- 最低限必要な情報:
  - `user_id`（作成者）
  - `project_id`
  - `event`（例: `project_created`）
  - `occurred_at`（作成日時）
- 集計は後続でも良いが、週次集計ができる情報は保持する

### 4.8 プラン選択（将来用）
- ユーザーが「プラン」を選択し保存できる
- **選択しても現時点では上限/保持期間は変わらない**
- 目的は将来の課金/制限解除実装に備えること

### 4.9 エラーハンドリング
- **動画アップロード失敗**:
  - ファイルサイズ超過（>500MB）: バリデーションエラー、エラーメッセージ表示
  - 非対応MIME: バリデーションエラー、対応形式リスト表示
  - ストレージ容量不足: システムエラー、管理者通知
- **プロジェクト作成失敗**:
  - 上限超過（10件）: バリデーションエラー、制限メッセージ表示
  - DB接続エラー: システムエラー、リトライ案内
- **注釈保存失敗**:
  - JSONフォーマットエラー: クライアント側バリデーション、再試行可能
  - DB書き込みエラー: システムエラー、自動バックアップから復元案内
- **スナップショット保存失敗**:
  - ストレージ書き込みエラー: システムエラー、リトライ案内
  - path無しスナップショット: 警告ログ、削除対象外として扱う
- **共有リンクアクセス**:
  - 無効なトークン: 404エラー
  - 削除済みプロジェクト: 404エラー、"プロジェクトが見つかりません"
- **自動削除・通知エラー**:
  - メール送信失敗: キューリトライ（最大3回）、失敗時は管理者通知
  - ファイル削除失敗: ログ記録、次回削除コマンドで再試行
- **認証・認可エラー**:
  - 未認証: 302リダイレクト（ログインページ）
  - 権限不足: 403エラー、"権限がありません"
  - メール未確認: verified middleware でリダイレクト

## 5. 非機能要件

### 5.1 パフォーマンス要件
- **動画アップロード**: 500MB動画を10分以内に完了（標準的なブロードバンド環境）
- **注釈保存**: レスポンス時間 <500ms（ペイロード <100KB想定）
- **共有ページ読み込み**: 初回表示 <3秒（動画バッファリング含まず）
- **同時ユーザー**: 100同時接続を想定（MVP段階）
- **KPIクエリ**: 週次集計クエリ <5秒（10,000イベント想定）

### 5.2 可用性要件
- **目標稼働率**: 99%（月間ダウンタイム <7.2時間許容）
- **メンテナンス**: 計画メンテナンスは深夜帯（JST 02:00-04:00）、事前通知
- **バックアップ**: DB日次バックアップ、7日間保持
- **ストレージ**: ファイルシステムバックアップ（週次）

### 5.3 セキュリティ要件
- **認証/認可**: Fortify + Policy（編集はオーナーのみ）
- **CSRF保護**: Laravel標準のCSRFトークン検証
- **XSS対策**: Bladeエスケープ、Content Security Policy推奨
- **ファイルアップロード**: MIMEタイプ検証、ファイル名サニタイズ
- **共有トークン**: 64文字ランダム文字列、推測不可能
- **SQL Injection**: Eloquent ORM使用、生クエリ禁止

### 5.4 運用・監視要件
- **ログ**: Laravel Log（`storage/logs`）、日次ローテーション
- **監視項目**:
  - ストレージ使用率（80%超で警告）
  - キュー滞留（10件超で警告）
  - 削除コマンド実行状態（日次確認）
  - メール送信失敗率（5%超で警告）
- **アラート**: 管理者メール通知（critical エラー時）
- **メトリクス**: KPIイベントテーブルから週次レポート生成
- **対応端末**: 当面PC優先
- **テスト**: Pest（Feature中心）

### 5.5 デプロイ要件
- **プラットフォーム**: Laravel Sail（Docker）使用を想定、本番環境は要調整
- **環境変数**: `.env` に以下を設定
  - `APP_ENV`, `APP_KEY`, `APP_DEBUG`
  - `DB_*`: データベース接続情報
  - `MAIL_*`: メール送信設定（通知機能に必須）
  - `FILESYSTEM_DISK`: ストレージディスク設定
- **マイグレーション**: デプロイ時に `php artisan migrate` 実行必須
- **ストレージリンク**: 初回デプロイ時に `php artisan storage:link` 実行
- **キューワーカー**: `php artisan queue:work` をデーモン起動（supervisor推奨）
- **スケジューラー**: cron設定 `* * * * * php artisan schedule:run`
- **ゼロダウンタイムデプロイ**: 推奨（Laravel Envoyer等）
- **ロールバック**: マイグレーションロールバック手順を事前確認
- **ヘルスチェック**: `/` エンドポイントで200応答確認

## 6. 受け入れ条件（Acceptance Criteria）

### 6.1 機能受け入れ条件

**Happy Path**:
- ✅ プロジェクト作成〜動画アップロード〜注釈保存〜共有閲覧のフルフローがPest Featureテストで通る
- ✅ KPIイベントがプロジェクト作成時にDBへ記録される
- ✅ プラン選択が保存され、選択内容が永続化される

**バリデーション**:
- ✅ 500MB超の動画アップロードに対し、バリデーションエラーを返す
- ✅ 無料ユーザーで10件超の作成リクエストに対し、制限メッセージが返る
- ✅ 非対応MIME（例: video/avi）のアップロードに対し、バリデーションエラーを返す
- ✅ 無効なプラン値（例: "premium"）に対し、バリデーションエラーを返す

**共有機能**:
- ✅ 共有リンクで閲覧できる（匿名OK、readOnly）
- ✅ 共有閲覧者が保存系エンドポイントへアクセスすると拒否される（302リダイレクト許容）
- ✅ 無効な共有トークンで404エラーが返る

**自動削除・通知**:
- ✅ 7日経過データの削除コマンドが存在し、対象レコード/ファイル/スナップショットが消える（テストで確認）
- ✅ 削除24時間前の通知コマンドが存在し、メール通知が送信される（テストで確認）
- ✅ 複数動画を持つユーザーへの通知が1通にまとめられる（グルーピング）

**スナップショット削除契約**:
- ✅ スナップショット保存時に `path` が必ず保存される
- ✅ `path` 無しスナップショットは削除時に警告ログを出力し、ファイル削除をスキップする
- ✅ E2Eテスト（SnapshotDeletionContractTest）で保存→削除の契約が保証される

### 6.2 エッジケース受け入れ条件

**同時実行**:
- ✅ 同一ユーザーが10件目と11件目を同時作成した場合、どちらか一方のみ成功する（排他制御）
- ✅ スナップショット保存中の注釈更新で、データ競合が発生しない

**境界値**:
- ✅ ちょうど500MBの動画がアップロード可能
- ✅ 7日ちょうどのデータが削除対象になる
- ✅ 6日23時間59分のデータが通知対象になる

**例外処理**:
- ✅ ストレージ書き込み失敗時、ユーザーにエラーメッセージが表示される
- ✅ メール送信失敗時、キューが最大3回リトライする
- ✅ DB接続エラー時、適切なエラーページが表示される

**データ整合性**:
- ✅ 動画削除時、関連する注釈・スナップショット・KPIイベントもカスケード削除される
- ✅ プロジェクト削除時、関連する動画・スナップショット・KPIイベントもカスケード削除される

### 6.3 非機能受け入れ条件

**パフォーマンス**:
- ✅ 注釈保存APIレスポンスが500ms以内（100KBペイロード）
- ✅ 共有ページ初回表示が3秒以内（動画バッファリング除く）
- ✅ KPI週次集計クエリが5秒以内（10,000イベント）

**セキュリティ**:
- ✅ CSRFトークン検証が全POSTリクエストで機能する
- ✅ 他人のプロジェクトへの編集リクエストが403エラーで拒否される
- ✅ XSS攻撃を試みる注釈データがエスケープされる

**運用**:
- ✅ 削除コマンドがスケジューラーで日次実行される
- ✅ 通知コマンドがスケジューラーで日次実行される
- ✅ エラーログが `storage/logs` に記録される

### 6.4 Definition of Done

各機能は以下をすべて満たした時点で「完了」とする：

1. **コード品質**:
   - Pest Featureテストが全てパス（カバレッジ≥80%目標）
   - PHPStanレベル5でエラー無し（推奨）
   - Laravel規約に準拠したコーディング

2. **ドキュメント**:
   - 重要なアーキテクチャ決定は `CLAUDE.md` に記載
   - Critical Contractは明示的にドキュメント化

3. **動作確認**:
   - ローカル環境で手動動作確認完了
   - エッジケースを含むテストケースが実装済み

4. **レビュー**:
   - コードレビュー完了（単独開発時は自己レビュー）
   - セキュリティチェックリスト確認

5. **デプロイ準備**:
   - マイグレーションファイルが正常動作
   - 環境変数設定ガイドが更新済み（必要な場合）
   - ロールバック手順が確認済み

## 7. 未決・要検討（次の要件確定で詰める）
- プランの選択肢（例: Free/Pro）と表記、変更可否（いつでも変更？）
- KPIイベントのテーブル名/設計詳細（汎用イベントテーブルか、project_events専用か）
- KPIの集計表示（ダッシュボード表示の有無、週の定義、タイムゾーン）

